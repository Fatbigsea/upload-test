<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title></title>
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/vant@2.12/lib/index.css"
    />
    <script
      type="text/javascript"
      src="https://res.wx.qq.com/open/js/jweixin-1.6.0.js"
    ></script>
    <script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/vant@2.12/lib/vant.min.js"></script>
    <script src="https://cdn.bootcss.com/jquery/3.5.1/jquery.min.js"></script>
  </head>
  <style type="text/css">
    body {
      margin: 0;
    }
    .uploadComponent {
      position: relative;
      height: 100vh;
    }

    .upload-nav {
      width: 100%;
      height: 100px;
      background-color: #4072f4;
    }

    .upload-header {
      position: relative;
      width: 90%;
      margin: 0 auto;
      height: 260px;
      background-color: #fff;
      border-radius: 5px;
      box-shadow: 0 0 12px 5px #f6f6f6;
      position: relative;
      top: -60px;
    }

    .upload-header p {
      position: absolute;
      bottom: 10px;
      left: 50%;
      transform: translate(-50%, 0);
      font-size: 32px;
      color: #474a51;
    }
    .van-uploader {
      position: absolute;
      left: 50%;
      width: 100px;
      height: 100px;
      box-sizing: border-box;
      transform: translate(-50%, 30%);
      display: inline-block;
      border: 6px solid #4072f4;
      text-decoration: none;
      text-align: center;
      line-height: 72px;
      border-radius: 50%;
      color: #4072f4;
    }
    .van-uploader-btn {
      border: none;
      font-size: 50px;
      font-weight: 700;
      background: none;
      color: #4072f4 !important;
      text-align: center;
    }
    .img-header {
      width: 100%;
      border-bottom: 2px solid #ebebeb;
      margin-bottom: 40px;
      color: #83888e;
      padding-bottom: 10px;
      font-size: 32px;
    }

    .pdf-img {
      position: absolute;
      top: 22%;
      left: 5%;
      width: 90%;
    }

    .pdf-img .img-item {
      position: relative;
      display: inline-block;
      width: 290px;
    }
    .del-button {
      border-radius: 50%;
      position: relative;
      left: 220px;
      top: -270px;
      z-index: 1;
      width: 50px;
      height: 50px;
      font-size: 50px;
      background-color: #4072f4;
      color: #fff;
      border: none;
    }

    .upload-bottom-button {
      position: absolute;
      right: 5%;
      top: 90%;
    }

    .cancel-button,
    .confirm-button {
      width: 160px;
      height: 80px;
      border-radius: 12px;
      font-size: 32px;
      text-align: center;
      line-height: 80px;
      border: none;
    }

    .confirm-button {
      background-color: #4072f4;
      color: #fff;
    }
    .cancel-button {
      background-color: #eee;
    }
  </style>

  <body>
    <div id="uploadPDF">
      <div class="uploadComponent">
        <div class="upload-nav"></div>
        <div class="upload-header">
          <van-uploader
            v-model="fileList"
            accept="file"
            multiple
            :preview-image="false"
            :before-read="handleBeforeRead"
            :after-read="handleAfterRead"
          >
            <van-button
              class="van-uploader-btn"
              icon="plus"
              plain
              type="info"
            ></van-button>
          </van-uploader>
          <p>上传PDF文件</p>
        </div>
        <!-- pdf图片反显区域 -->
        <div class="pdf-img" id="pdfImg">
          <div class="img-header" v-if="imgSrcList.length > 0">已上传</div>
          <div class="img-item" v-for="(img,idx) in imgSrcList" :key="idx">
            <van-image
              width="250"
              height="250"
              radius="12"
              :src="img.url"
              @click="handlePreviewImg(img.url,idx)"
            ></van-image>
            <van-icon
              class="del-button"
              name="close"
              @click="handleDelete(img.invoiceId,idx)"
            />
          </div>
        </div>
        <!-- 底部按钮区域 -->
        <div class="upload-bottom-button">
          <van-button class="confirm-button" type="info" @click="handleConfirm"
            >确认</van-button
          >
          <van-button class="cancel-button" @click="handleDelete()"
            >清空</van-button
          >
        </div>
      </div>
    </div>
    <script type="text/javascript">
      var vue = new Vue({
        el: '#uploadPDF',
        template: ``,
        data: function() {
          return {
            fileList: [], //上传文件列表
            imgSrcList: [], //图片Scr列表
          };
        },
        methods: {
          /*
           * 上传前进行校验（上传的多个文件都应该是pdf）
           * 允许上传多个文件，将上传的文件构建一个新数组，构建文件类型的数组
           * 判断文件类型的每一项是否有不为pdf的文件
           * 如果有则不允许上传
           */
          handleBeforeRead(file) {
            let fileList = [];
            let fileTypeList = [];
            fileList = fileList.concat(file);
            fileTypeList = fileList.map((file) => file.type);
            let flag = fileTypeList.some((e) => e !== 'application/pdf');
            if (flag) {
              alert('存在不是pdf的文件');
              return false;
            }
            return true;
          },
          /*
           * 处理上传成功之后的回调
           * 遍历文件列表的每一项，单个文件上传
           */
          handleAfterRead(file) {
            let fileList = [];
            fileList = fileList.concat(file);
            fileList.forEach((file) => {
              let fileForm = this.buildParams(file.file);
              this.uploadFile(fileForm);
            });
          },
          /**
           * 构建参数
           * mobile,agyId通过路由地址获取
           */
          buildParams(file) {
            let params = new FormData();
            params.append('mobile', '3319d08f9268e57b0dfcd9c069196cd0');
            params.append('agyId', '1283577844798099458');
            params.append('file', file);
            return params;
          },
          /**
           * 上传附件
           * 将构建的参数
           * 将获取的数据push到显示图片的数组中
           */
          uploadFile(params) {
            let _this = this;
            $.ajax({
              url:
                'http://192.168.2.129:30000/platform/external/invoice/webInvoiceBatch',
              type: 'post',
              data: params,
              contentType: false,
              processData: false,
              success: function(res) {
                if (res.code !== 0) {
                  alert(res.msg);
                  return;
                }
                var data = res.data;
                if (_this.isNotEmpty(data)) {
                  data.webH5VoList[0].url =
                    'data:image/png;base64,' + data.webH5VoList[0].imageBase64;
                  _this.imgSrcList.push(data.webH5VoList[0]);
                }
              },
              error: function(err) {
                console.error(err);
              },
            });
          },
          /**
           * 处理文件删除
           * TODO:pdf删除接口,根据传参来判断是单个删除还是全部清空
           *     存在参数，是单个删除
           */
          handleDelete(invoiceId, idx) {
            let _this = this;
            let invoiceIdList = [];
            if (this.isEmpty(invoiceId)) {
              invoiceIdList = this.imgSrcList.map((item) => item.invoiceId);
            } else {
              invoiceIdList.push(invoiceId);
            }
            let params = new FormData();
            params.append('invoiceIdStrList', invoiceIdList);
            $.ajax({
              url:
                'http://192.168.2.129:30000/platform/external/invoice/webDeletePdfUrl',
              type: 'post',
              data: params,
              contentType: false,
              processData: false,
              async: true,
              success: function(res) {
                if (res.code !== 0) {
                  alert(res.msg);
                }
                if (_this.isEmpty(invoiceId)) {
                  _this.imgSrcList = [];
                } else {
                  _this.imgSrcList.splice(idx, 1);
                }
              },
              error: function(err) {
                console.error(err);
              },
            });
          },
          /*
           * 处理图片预览
           */
          handlePreviewImg(url, index) {
            vant.ImagePreview({
              images: [url], // 预览图片的那个数组
              showIndex: true,
              loop: false,
              startPosition: index, // 指明预览第几张图
            });
          },
          /*
           * 处理确认
           * TODO:走后端已提交接口,成功后，返回小程序首页
           */
          handleConfirm() {
            wx.miniProgram.navigateTo({
              url: '/pages/button/index',
            });
          },
          /**
           * 判断是否为空
           */
          isEmpty(value) {
            if (typeof value === 'undefined') {
              return true;
            } else if (value === null) {
              return true;
            } else if (typeof value === 'string' && value === '') {
              return true;
            } else if (typeof value === 'number' && isNaN(value)) {
              return true;
            } else if (Array.isArray(value) && value.length === 0) {
              return true;
            } else if (value instanceof Number && isNaN(value)) {
              return true;
            } else if (
              value.toString() === '[object Object]' &&
              Object.keys(value).length === 0
            ) {
              return true;
            } else {
              return false;
            }
          },
          /**
           * 判断是否为不为空
           */
          isNotEmpty(value) {
            return !this.isEmpty(value);
          },
        },
        created(){
          var param =window.location.href;
          console.log(param);
        }
      });
    </script>
  </body>
</html>
